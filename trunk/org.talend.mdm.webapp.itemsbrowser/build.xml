<?xml version="1.0" encoding="UTF-8"?>
<project default="all">

  <property name="version.props" value="version.properties" />

  <property name="jboss.dir" value="/home/pascal/dev/jboss/jboss-4.2.2.GA-mdm" />
  <property name="jboss.instance.dir" value="${jboss.dir}/server/default" />
  <property name="jboss.deploy.dir" value="${jboss.instance.dir}/deploy" />
  <property name="jboss.instance.lib" value="${jboss.instance.dir}/lib" />

  <property name="webapp.core.lib" value="../org.talend.mdm.webapp.core/z.mdm.webapp.core.jar" />
  <property name="war" value="zz.20.webapp.browseitems.war" />

  <property name="tom.location" value="${basedir}/.." />

  <!-- ================================= 
          target: all              
         ================================= -->
  <target name="all" depends="version,package,undeploy,deploy" description="--> Browse Items WebApp">
    <!--eclipse.refreshLocal resource="../"/-->
  </target>

  <target name="version" description="Maintain build.date property">
    <buildnumber file="${version.props}" />
    <propertyfile file="${version.props}">
      <entry key="build.date" type="date" value="now" />
    </propertyfile>
  </target>

  <target name="junit">
    <delete dir="${basedir}/target/test-classes" />
    <mkdir dir="${basedir}/target/test-classes" />

    <delete dir="${basedir}/target/test-reports" />
    <mkdir dir="${basedir}/target/test-reports" />

    <path id="base.classpath">
      <pathelement path="bin" />
      <pathelement path="${tom.location}/org.talend.mdm.commmon/bin" />
      <pathelement path="${tom.location}/org.talend.mdm.xmlserver.interfaces/bin" />
      <pathelement path="${tom.location}/org.talend.mdm.webapp.core/bin" />
      <pathelement path="${tom.location}/org.talend.mdm.core/bin" />
      <pathelement path="${tom.location}/org.talend.mdm.commons.core/bin" />
      <pathelement path="${tom.location}/talend.mdm.libraries/lib/jboss-jmx.jar" />
      <pathelement path="${tom.location}/talend.mdm.libraries/lib/jboss-j2ee.jar" />
      <pathelement path="${tom.location}/talend.mdm.libraries/lib/log4j.jar" />
      <pathelement path="${tom.location}/talend.mdm.libraries/lib/z.xsom.jar" />
      <pathelement path="${tom.location}/talend.mdm.libraries/lib/z.commons-jxpath-1.3.jar" />
      <pathelement path="${tom.location}/talend.mdm.libraries/lib/xercesImpl-2.9.1.jar" />
    </path>

    <path id="compile.classpath">
      <pathelement path="${tom.location}/talend.mdm.libraries/lib/junit-3.8.1.jar" />
      <path refid="base.classpath" />
    </path>

    <path id="test.classpath">
      <pathelement path="target/test-classes" />
      <path refid="compile.classpath" />
    </path>

    <copy todir="${basedir}/target/test-classes" verbose="true">
      <fileset dir="${basedir}/test" excludes="**/*.java" />
    </copy>

    <javac srcdir="${basedir}/test" destdir="${basedir}/target/test-classes">
      <classpath>
        <path refid="compile.classpath" />
      </classpath>
    </javac>

    <junit printsummary="yes" haltonfailure="yes" showoutput="yes">
      <classpath>
        <path refid="test.classpath" />
      </classpath>

      <batchtest fork="yes" todir="target/test-reports">
        <fileset dir="target/test-classes">
          <include name="**/*Test.class" />
        </fileset>
      </batchtest>

      <formatter type="plain" />
      <formatter type="xml" />
    </junit>
  </target>

  <target name="package" depends="junit">
    <property file="${version.props}" />
    <copy file="RELEASE.NOTES" tofile="RELEASE-${major}.${minor}.${rev}-${build.number}.NOTES" />
    <jar destfile="${war}">
      <zipfileset dir="src/WEB-INF" prefix="WEB-INF">
        <include name="web.xml" />
      </zipfileset>
      <zipfileset dir="src/WEB-INF" prefix="WEB-INF">
        <include name="jboss-web.xml" />
      </zipfileset>
      <zipfileset dir="src/WEB-INF" prefix="WEB-INF">
        <include name="dwr.xml" />
      </zipfileset>
      <!--<zipfileset file="${webapp.core.lib}" prefix="WEB-INF/lib"/>-->
      <zipfileset dir=".">
        <include name="version.properties" />
      </zipfileset>
      <zipfileset dir=".">
        <include name="RELEASE-${major}.${minor}.${rev}-${build.number}.NOTES" />
      </zipfileset>
      <zipfileset dir="bin" prefix="WEB-INF/classes" includes="**/*.class" />
      <zipfileset dir="src" prefix="WEB-INF/classes" includes="**/*.properties" />
      <zipfileset dir="web" includes="**/*" />
      <zipfileset dir="src" prefix="WEB-INF/classes" includes="**/*.xsl" />
      <zipfileset dir="libs" prefix="WEB-INF/lib" includes="*.jar" />
      <zipfileset dir="." prefix="WEB-INF" includes="itemsbrowser.properties" />
    </jar>
    <delete file="RELEASE-${major}.${minor}.${rev}-${build.number}.NOTES" />
  </target>

  <target name="undeploy" description="remove packages">
    <delete>
      <fileset dir="${jboss.deploy.dir}" includes="${war}" />
    </delete>
  </target>

  <target name="deploy">
    <echo>Deploying ${war} </echo>
    <copy file="${war}" tofile="${jboss.deploy.dir}/${war}" />
  </target>


</project>

